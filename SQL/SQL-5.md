## Типы данных ##

### Схема датасета ###

![Схема датасета](schema4.png)

----

### city ###

    city_id     INTEGER     уникальный идентификатор города, первичный ключ
    city_name   TEXT        название города
    state       TEXT        штат, к которому относится город
    population  INTEGER     население города
    area        NUMERIC     площадь города

----

### customer ###

    cust_id         INTEGER     уникальный идентификатор клиента, первичный ключ
    cust_name       TEXT        название клиента
    annual_revenue  NUMERIC     ежегодная выручка
    cust_type       TEXT        тип пользователя
    address         TEXT        адрес
    zip             INTEGER     почтовый индекс
    phone           TEXT        телефон
    city_id         INTEGER     идентификатор города, внешний ключ к таблице city

----

### driver ###

    driver_id       INTEGER     уникальный идентификатор водителя, первичный ключ
    first_name      TEXT        имя водителя
    last_name       TEXT        фамилия водителя
    address         TEXT        адрес водителя
    zip_code        INTEGER     почтовый индекс водителя
    phone           TEXT        телефон водителя
    city_id         INTEGER     идентификатор города водителя, внешний ключ
                                к таблице city

----

### truck ###

    truck_id    INTEGER     Уникальный идентификатор грузовика, первичный ключ
    make        TEXT        Производитель грузовика
    model_year  INTEGER     Дата выпуска грузовика

----

### shipment ###

    ship_id     INTEGER     уникальный идентификатор доставки, первичный ключ
    cust_id     INTEGER     идентификатор клиента, которому отправлена доставка,
                            внешний ключ к таблице customer
    weight      NUMERIC     вес посылки
    truck_id    INTEGER     идентификатор грузовика, на котором отправлена доставка,
                            внешний ключ к таблице truck
    driver_id   INTEGER     идентификатор водителя, который осуществлял доставку,
                            внешний ключ к таблице driver
    city_id     INTEGER     идентификатор города в который совершена доставка,
                            внешний ключ к таблице city
    ship_date   DATE        дата доставки

----

#### **Задание 1** ####

Узнать, сколько сейчас времени в другом регионе, например Лос-Анджелесе.    
Написать запрос, который выведет текущие время и дату в часовом поясе
Лос-Анджелеса (`'America/Los_Angeles'`). Столбец в выдаче&nbsp;&mdash; **now**
(время и дата в нужном часовом поясе).

```sql
SELECT NOW() AT TIME ZONE 'America/Los_Angeles' AS now
```

----

#### **Задание 2** ####

Есть дата и время какого-то события и надо посмотреть, к какой дате оно
относится для Москвы и для UTC? Использовать подзапрос:

```text
with x as 
(
select '2018-12-31 21:00:00+00'::timestamp with time zone ts
)
```

и вывести дату в **ts** в Московском часовом поясе и в поясе UTC. Столбцы в
выдаче: `dt_msk` (дата в московском часовом поясе), `dt_utc` (дата в UTC).

```sql
WITH x AS (SELECT '2018-12-31 21:00:00+00'::timestamp WITH TIME ZONE AS ts)
SELECT
    (ts AT TIME ZONE 'Europe/Moscow')::date AS dt_msk,
    ts::date AS dt_utc
FROM x
```

----

#### **Задание 3** ####

Посчитать помесячную статистику по доставкам, используя функцию `extract`.    
Написать запрос, который выведет год, месяц и количество доставок. Отсортировать
по году и по месяцу в порядке возрастания. Столбцы в выдаче: `year_n` (номер
года), `month_n` (номер месяца), `qty` (количество доставок).

```sql
SELECT
    EXTRACT(YEAR FROM ship_date) AS year_n,
    EXTRACT(MONTH FROM ship_date) AS month_n,
    COUNT(*) AS qty
FROM sql.shipment
GROUP BY year_n, month_n
ORDER BY year_n, month_n
```

----

#### **Задание 4** ####

Вывести текст текущего времени для сервиса точного времени.    
Написать запрос, который выводит текст "Точное время x часов y минут z секунд"
(текст в кавычки заключать не нужно), где `x`, `y`, `z`&nbsp;&mdash; часы,
минуты и секунды соответственно, при условии, что сообщение нужно вывести для
московского часового пояса. Время введите в 24-часовом формате. Столбцы в
выдаче: `msg (сообщение)`.

```sql
SELECT
    TO_CHAR(
        NOW() AT TIME ZONE 'Europe/Moscow', 'Точное время HH24 часов MI минут SS секунд'
    ) AS "msg (сообщение)"
```

----

#### **Задание 5** ####

Подготовить данные для квартальной отчётности компании.    
Написать запрос, который выведет дату доставки, округлённую до квартала, и общую
массу доставок. Отсортируйте по кварталу в порядке возрастания. Столбцы в
выдаче: `q` (начало квартала, тип `date`), `total_weight` (сумма масс доставок
за квартал).

```sql
SELECT
    TO_CHAR(DATE_TRUNC('quarter', ship_date), 'YYYY-MM-DD') AS q,
    SUM(weight) AS total_weight
FROM sql.shipment
GROUP BY q
ORDER BY q
```

----

#### **Задание 6** ####

Оценить, в каком интервале совершались доставки в разных городах.    
Написать запрос, который выведет разницу между последним и первым днём доставки
по каждому городу. Отсортировать по первому и второму столбцам. Столбцы в
выдаче: `city_name` (название города) и `days_active` (время от первой до
последней доставки в днях).

```sql
SELECT
    c.city_name,
    MAX(s.ship_date) - MIN(s.ship_date) AS days_active
FROM sql.shipment AS s
JOIN sql.city AS c ON
    s.city_id = c.city_id
GROUP BY c.city_name
ORDER BY c.city_name, days_active
```

----

#### **Задание 7** ####

Составить текстовый шаблон сообщения о доставке по конкретному водителю для
клиентов.    
Написать SQL-запрос, который выведет следующее сообщение для каждого водителя по
форме:
`Ваш заказ доставит водитель #Имя Фамилия#. Его контактный номер: #Номер#`, где
`#Имя Фамилия#` и `#Номер#` взяты из справочника водителей. Если номер не
указан, то вывести прочерк (`-`). Для номеров рекомендуется использовать
**`COALESCE`**. Пример из таблицы для наглядности:
`Ваш заказ доставит водитель Adel Al-Alawi. Его контактный номер: (901) 947-4433`
Столбец к выдаче&nbsp;&mdash; `msg (текст сообщения)`.

```sql
SELECT
    'Ваш заказ доставит водитель ' ||
    first_name ||
    ' ' ||
    last_name ||
    '. Его контактный номер: ' ||
    COALESCE(phone, '-')
    AS "msg (текст сообщения)"
FROM sql.driver
```

----

#### **Задание 8** ####

Cоставить справочник названий клиентов, у которых более десяти доставок. Данные
сохранить в нижнем регистре, чтобы передавать их в другие системы (например, для
обзвона), которые не чувствительны к регистру.    
Написать запрос, который выводит все `id` названий клиентов, у которых более
десяти доставок, в нижнем регистре. Отсортировать результат по `cust_id` в
порядке возрастания. Столбцы в выдаче: `cust_id` (id клиента) и `cust_name`
(название клиента в нижнем регистре).

```sql
SELECT
    s.cust_id,
    LOWER(c.cust_name) AS cust_name
FROM sql.shipment AS s
JOIN sql.customer AS c ON
    s.cust_id = c.cust_id
GROUP BY s.cust_id, c.cust_name
HAVING COUNT(s.ship_id) > 10
ORDER BY s.cust_id
```

----
